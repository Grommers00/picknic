<!DOCTYPE html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Add a Picnic Table [test]</title>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
    <style>
      html, body {
        height: 100%;
        margin: 0.25em;
      }
      #map {
        height: 75%;
        width: 100%;
        margin-bottom: 0.5em;
      }
    </style>
  </head>
  <body>
    <form class="pure-form">
      <fieldset>
        <legend>Map</legend>
        <input id="address" type="text" class="pure-input-1" placeholder="Enter a Location">
      </fieldset>
    </form>
    <div id="map"></div>
    <form class="pure-form pure-form-stacked">
      <fieldset>
        <legend>Location</legend>
        <div class="pure-g">
          <div class="pure-u-1 pure-u-md-4-24">
            <style scoped>
              .button-special {
                background: rgb(66, 184, 221);
                color: white;
                font-size: 85%;
                margin-bottom:0.25em;
              }
            </style>
            <a id="move_map_center" class="pure-button button-special pure-u-23-24"><i class="fa fa-map" aria-hidden="true"></i> Map Center</a>
            <a id="move_current" class="pure-button button-special pure-u-23-24"><i class="fa fa-location-arrow" aria-hidden="true"></i> Current Location</a>
          </div>
          <div class="pure-u-1 pure-u-md-10-24">
            <label for="latitude">Latitude</label>
            <input id="latitude" class="pure-u-23-24" type="number" placeholder="Latitude" min="-90" max="90" step="0.00001">
          </div>
          <div class="pure-u-1 pure-u-md-10-24">
            <label for="longitude">Longitude</label>
            <input id="longitude" class="pure-u-23-24" type="number" placeholder="Longitude" min="-180" max="180" step="0.00001">
          </div>
        </div>
        <legend>Attributes</legend>
        <button type="submit" class="pure-button pure-button-primary">Submit</button>
      </fieldset>
    </form>
    <script>
      function trimPretty(number) {
        return parseFloat(parseFloat(number).toFixed(5))
      }

      // Render the map after Google Maps loads
      function initMap() {
        var initialPoint = {lat: 53.5444, lng: -113.4904};

        // Map Customization
        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 17,
          minZoom: 16,
          center: initialPoint,
          scrollwheel: false,
          streetViewControl: true,
          streetViewControlOptions: {position: google.maps.ControlPosition.LEFT_TOP},
          styles: [{"featureType":"administrative","elementType":"labels.text.fill","stylers":[{"color":"#444444"}]},{"featureType":"landscape","elementType":"geometry.fill","stylers":[{"visibility":"on"},{"color":"#f2f2f2"}]},{"featureType":"landscape","elementType":"geometry.stroke","stylers":[{"color":"#cacaca"}]},{"featureType":"poi","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"poi.park","elementType":"all","stylers":[{"visibility":"on"}]},{"featureType":"poi.park","elementType":"geometry.fill","stylers":[{"color":"#a8d49f"}]},{"featureType":"poi.school","elementType":"labels","stylers":[{"visibility":"on"}]},{"featureType":"poi.sports_complex","elementType":"geometry.fill","stylers":[{"visibility":"on"},{"color":"#ffd0b2"}]},{"featureType":"poi.sports_complex","elementType":"labels","stylers":[{"visibility":"on"}]},{"featureType":"road","elementType":"all","stylers":[{"saturation":-100},{"lightness":45}]},{"featureType":"road.highway","elementType":"all","stylers":[{"visibility":"simplified"}]},{"featureType":"road.arterial","elementType":"labels.icon","stylers":[{"visibility":"off"}]},{"featureType":"transit","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"water","elementType":"geometry.fill","stylers":[{"color":"#b3e3f9"}]}]
        });

        // Markers
        var tableMarker = new google.maps.Marker({
          draggable:true,
          icon:'https://new.picknic.site/images/marker_picnic_table_20.png',
          map: map,
          position: initialPoint
        });
        var locationMarker = new google.maps.Marker({
          clickable: false,
          icon: new google.maps.MarkerImage('https://maps.gstatic.com/mapfiles/mobile/mobileimgs2.png', new google.maps.Size(22,22), new google.maps.Point(0,18), new google.maps.Point(11,11)),
          map: map,
          shadow: null,
          zIndex: 999
        });

        // Setup Autocomplete
        var input = document.getElementById('address');
        var autocomplete = new google.maps.places.Autocomplete(input);
        autocomplete.bindTo('bounds', map);
        autocomplete.addListener('place_changed', function() {
          var place = autocomplete.getPlace();
          if(!place.geometry) {
            console.log("No geometry for place!");
            return;
          }

          // Re-center map
          if(place.geometry.viewport) {
            map.fitBounds(place.geometry.viewport);
          } else {
            map.setCenter(place.geometry.location);
            map.setZoom(17);
          }
        });

        // Try to get & track user location
        if(navigator.geolocation) {
          navigator.geolocation.watchPosition(function(position) {
            // If the position is updated, move the dot
            locationMarker.setPosition({lat: position.coords.latitude, lng: position.coords.longitude});
          }, function() {
            consle.log("failed following geolocation");
          }, function() {
            // TODO: On Error
          }, {
            enableHighAccuracy: true
          });
        }

        var lat_input = document.getElementById("latitude");
        var lng_input = document.getElementById("longitude");

        // Initial Values
        lat_input.value = initialPoint.lat;
        lng_input.value = initialPoint.lng;

        // Update input coordinates when tableMarker is dragged
        google.maps.event.addListener(tableMarker, 'dragend', function() {
          // Update Coordinate Inputs
          var position = this.getPosition();
          var prettyLat = trimPretty(position.lat());
          var prettyLng = trimPretty(position.lng());
          this.setPosition({lat: prettyLat, lng: prettyLng});
          lat_input.value = prettyLat;
          lng_input.value = prettyLng;
        });

        // Update tableMarker when input coordinates are changed
        lat_input.addEventListener("change", function() {
          var new_lat = trimPretty(this.value);
          this.value = new_lat;
          var old_lng = tableMarker.getPosition().lng();
          tableMarker.setPosition({lat: new_lat, lng: old_lng});
        });        
        lng_input.addEventListener("change", function() {
          var new_lng = trimPretty(this.value);
          this.value = new_lng;
          var old_lat = tableMarker.getPosition().lat();
          tableMarker.setPosition({lat: old_lat, lng: new_lng});
        });

        // Move the table marker when the buttons are clicked
        var moveCenter = document.getElementById("move_map_center");
        moveCenter.addEventListener("click", function() {
          // Update Coordinate Inputs
          var position = map.getBounds().getCenter();
          var prettyLat = trimPretty(position.lat());
          var prettyLng = trimPretty(position.lng());
          tableMarker.setPosition({lat: prettyLat, lng: prettyLng});
          lat_input.value = prettyLat;
          lng_input.value = prettyLng;
        });
        var moveCurrent = document.getElementById("move_current");
        moveCurrent.addEventListener("click", function() {
          // Update Coordinate Inputs
          var position = locationMarker.getPosition();
          var prettyLat = trimPretty(position.lat());
          var prettyLng = trimPretty(position.lng());
          tableMarker.setPosition({lat: prettyLat, lng: prettyLng});
          lat_input.value = prettyLat;
          lng_input.value = prettyLng;
          map.setCenter(locationMarker.getPosition())
        });
        
        // Get picnic tables within the bounds
        google.maps.event.addListener(map, 'idle', function() {
          var ne = this.getBounds().getNorthEast();
          var ne_lat = ne.lat();
          var ne_lng = ne.lng();
          
          var sw = this.getBounds().getSouthWest();
          var sw_lat = sw.lat();
          var sw_lng = sw.lng();
          
          var box = {"box": [[sw_lng, sw_lat], [ne_lng, ne_lat]]}
          console.log("NE: " + ne_lng + ", " + ne_lat);
          console.log("SW: " + sw_lng + ", " + sw_lat);
          console.log("Box: " + JSON.stringify(box));
          
          $.ajax({
            type: 'POST',
            url: 'https://new.picknic.site/get/tables',
            data: 
          });
        });
      }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDHm7qJ-_By08XAFZfK5xuqjnuLOlyXwbs&callback=initMap&libraries=places"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-rc1/jquery.min.js"></script>
  </body>
</html>
