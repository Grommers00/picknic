<!DOCTYPE html>

<head>
  <meta name="theme-color" content="#a8d49f">
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <meta charset="utf-8">
  <title>Picknic</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0="
    crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha256-m/h/cUDAhf6/iBRixTbuc8+Rg2cIETQtPcH9D3p2Kg0="
    crossorigin="anonymous" />
  <link href="https://fonts.googleapis.com/css?family=Pacifico" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
    }

    .map {
      display: block;
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
    }

    nav.navbar {
      background-color: rgba(255, 255, 255, 0.8);
      height: 3em;
      z-index: 1;
    }

    nav.navbar img {
      border-radius: 5px;
      display: inline-block;
      width: 1.6em;
      height: 1.6em;
      margin: -0.4em 0.25em 0 0;
    }

    .navbar-brand {
      color: #000;
      text-shadow: 1px 1px 0 #EEE;
      font-family: 'Pacifico', cursive;
      font-size: 24px;
    }

    .navbar-brand:hover {
      color: #000;
    }

    .navbar-nav .nav-link {
      color: #333;
      line-height: 2em;
    }

    .navbar-nav .nav-link:hover {
      color: #111;
    }

    .navbar-nav .active {
      background-color: #cacaca;
      height: 100%;
    }
    /* puts the google places autocomplete dropdown results above the bootstrap modal 1050 zindex. */

    .pac-container {
      z-index: 1051 !important;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-md navbar-fixed-top navbar-custom">
    <a class="navbar-brand" href="#"><img alt="" src="/images/picknic.svg">Picknic</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar" aria-controls="navbar" aria-expanded="false"
      aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
    <div class="collapse navbar-collapse" id="navbar">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item active">
          <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">About</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Contact</a>
        </li>
      </ul>
      <form class="form-inline my-2 my-md-0" role="search">
        <div class="input-group mb-2 mb-sm-0">
          <div class="input-group-addon"><i class="fa fa-search" aria-hidden="true"></i></div>
          <input id="address" type="search" class="form-control" placeholder="Address Search" onkeypress="return event.keyCode != 13;">
        </div>
      </form>
    </div>
  </nav>

  <!-- Google Map -->
  <div class="map" id="map"></div>
  <script>
    // Map
    var mapDiv = document.getElementById('map');
    var addressInput = document.getElementById('address');

    function initMap() {
      var initialPoint = { lat: 53.5444, lng: -113.4904 };

      allTables = {};
      function populateTablesInRange(map, rangeCircle) {
        var circlePosition = rangeCircle.getCenter();
        var circleLat = circlePosition.lat();
        var circleLng = circlePosition.lng();
        var circleRadius = rangeCircle.getRadius() / 6367444.7;
        var circle = { "center": [circleLng, circleLat], "radius": circleRadius, "spherical": true };
        $.ajax({
          type: 'POST',
          url: '/data/tables/find/within',
          dataType: 'json',
          contentType: 'application/json',
          data: JSON.stringify(circle),
          success: function (tables) {
            for (var i = 0; i < tables.length; i++) {
              var table = tables[i];
              if (!allTables.hasOwnProperty(table._id)) {
                allTables[table._id] = true;
                map.data.addGeoJson(table);
              }
            }
          }
        });
      }

      // Map Customization
      var map = new google.maps.Map(mapDiv, {
        zoom: 15,
        minZoom: 13,
        center: initialPoint,
        scrollwheel: false,
        mapTypeControl: true,
        mapTypeControlOptions: { position: google.maps.ControlPosition.LEFT_BOTTOM },
        streetViewControl: true,
        scaleControl: true,
        fullscreenControl: false,
        // Style created on Snazzymaps -- https://snazzymaps.com/style/58514/picknic-lightwater
        styles: [{ "featureType": "administrative", "elementType": "labels.text.fill", "stylers": [{ "color": "#444444" }] }, { "featureType": "landscape", "elementType": "geometry.fill", "stylers": [{ "visibility": "on" }, { "color": "#f2f2f2" }] }, { "featureType": "landscape", "elementType": "geometry.stroke", "stylers": [{ "color": "#cacaca" }] }, { "featureType": "poi", "elementType": "all", "stylers": [{ "visibility": "off" }] }, { "featureType": "poi.park", "elementType": "all", "stylers": [{ "visibility": "on" }] }, { "featureType": "poi.park", "elementType": "geometry.fill", "stylers": [{ "color": "#a8d49f" }] }, { "featureType": "poi.school", "elementType": "labels", "stylers": [{ "visibility": "on" }] }, { "featureType": "poi.sports_complex", "elementType": "geometry.fill", "stylers": [{ "visibility": "on" }, { "color": "#ffd0b2" }] }, { "featureType": "poi.sports_complex", "elementType": "labels", "stylers": [{ "visibility": "on" }] }, { "featureType": "road", "elementType": "all", "stylers": [{ "saturation": -100 }, { "lightness": 45 }] }, { "featureType": "road.highway", "elementType": "all", "stylers": [{ "visibility": "simplified" }] }, { "featureType": "road.arterial", "elementType": "labels.icon", "stylers": [{ "visibility": "off" }] }, { "featureType": "transit", "elementType": "all", "stylers": [{ "visibility": "off" }] }, { "featureType": "water", "elementType": "geometry.fill", "stylers": [{ "color": "#b3e3f9" }] }]
      });
      map.data.setStyle(function (feature) {
        var icon = '';
        if (feature.getProperty("type") == "table") {
          icon = '/images/markers/table_brown.png'
        } else if (feature.getProperty("type") == "site") {
          icon = '/images/markers/site_grey.png'
        } else {
          // TODO: Create unknown marker
        }
        return {
          "icon": icon
        }
      });

      var assetInfoWindow = new google.maps.InfoWindow({
        //content: "Hello World!"
      });
      assetInfoWindow.setOptions({ pixelOffset: new google.maps.Size(0, -30) });
      // Display some stuff about the data if they click on it
      map.data.addListener('mouseover', function (event) {
        var comment = event.feature.getProperty("comment");
        if (comment) {
          assetInfoWindow.setContent(comment);
          assetInfoWindow.setPosition(event.feature.getGeometry().get());
          assetInfoWindow.open(map);
        }
      });
      map.data.addListener('mouseout', function (event) {
        assetInfoWindow.close();
      });

      // Markers
      var rangeCircle = new google.maps.Circle({
        clickable: false,
        strokeColor: "#b3e3f9",
        fillColor: "#b3e3f9",
        fillOpacity: 0.5,
        map: map,
        radius: 500
      });
      var locationMarker = new google.maps.Marker({
        clickable: true,
        icon: 'images/markers/picnic_basket.png',
        map: map,
        shadow: null,
        zIndex: 999
      });

      // // Clicking on the location marker brings up a menu where the use can alter the range of the search
      // var locationMarkerInfoWindow = new google.maps.InfoWindow({
      //   //content: "Hello World!"
      // });
      // locationMarker.addListener('mouseover', function () {
      //   locationMarkerInfoWindow.open(map, locationMarker);
      // });
      // locationMarker.addListener('mouseout', function () {
      //   locationMarkerInfoWindow.close(map, locationMarker);
      // });


      // When the user opens street view mode, bring the map to the front of the page so they can back out
      var thePanorama = map.getStreetView();
      google.maps.event.addListener(thePanorama, 'visible_changed', function () {
        console.log("Visible?: " + thePanorama.getVisible());
        if (thePanorama.getVisible()) {
          // Display your street view visible UI
          mapDiv.style.zIndex = 1051;
        } else {
          // Display your original UI
          mapDiv.style.zIndex = 0;
        }
      });

      // Setup Autocomplete
      var autocomplete = new google.maps.places.Autocomplete(addressInput);
      autocomplete.bindTo('bounds', map);
      autocomplete.addListener('place_changed', function () {
        var place = autocomplete.getPlace();
        if (!place.geometry) {
          console.log("No geometry for place!");
          return;
        }

        // Move Map
        map.setCenter(place.geometry.location);
        // Move Range Circle & Marker
        rangeCircle.setCenter(place.geometry.location);
        locationMarker.setPosition(place.geometry.location);

        // Get Tables
        populateTablesInRange(map, rangeCircle);
      });

      // Try to get user location
      var searchParams = new URLSearchParams(window.location.search);
      if (searchParams.has('lng') && searchParams.has('lat')) {
        try {
          var location = { lat: parseFloat(searchParams.get('lat')), lng: parseFloat(searchParams.get('lng')) }

          // Move Map
          map.setCenter(location);

          // Move Range Circle & Marker
          rangeCircle.setCenter(location);
          locationMarker.setPosition(location);

          // Get Tables
          populateTablesInRange(map, rangeCircle);
        } catch (e) {
          console.log(e);
        }

        // Zoom
        if (searchParams.has('zoom')) {
          try {
            map.setZoom(parseInt(searchParams.get('zoom')));
          } catch (e) {
            console.log(e);
          }
        }
      } else if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
          map.setCenter(initialLocation);
          locationMarker.setPosition(initialLocation);
          rangeCircle.setCenter(initialLocation);
          populateTablesInRange(map, rangeCircle);

          map.fitBounds(rangeCircle.getBounds())
        }, function () {
          // TODO: On error
        }, { enableHighAccuracy: "true" });
      }
    }
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAXjoe051ln4ZzllnDDgCBca0mcyidFtMo&amp;callback=initMap&amp;libraries=places"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha256-DiWJXXyq81WlPRnDfGmgYZj2aOVCKyEdJ1l+2TmDuAs="
    crossorigin="anonymous"></script>
</body>

</html>